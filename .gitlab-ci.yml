stages:
    - test
    - build
    - build-docker-image
    - sonarcloud-check

test:
    stage: test
    image: node:18.9.1-alpine3.16
    before_script:
        - npm install
    script:
        - npm run test:unit

build:
    stage: build
    needs:
        - test
    image: node:18.9.1-alpine3.16
    before_script:
        - npm install
    script:
        - npm run build

build-docker-image:
    stage: build-docker-image
    needs:
        - build
    image: docker:20.10.20-alpine3.16
    services:
        - name: docker:20.10.20-dind-alpine3.16
          alias: docker
    script:
        - docker login -u $DOCKER_USERNAME --password ${DOCKER_PASSWORD}
        - docker build -t ${DOCKER_USERNAME}/frontend:$CI_COMMIT_SHORT_SHA .
        - docker tag ${DOCKER_USERNAME}/frontend:$CI_COMMIT_SHORT_SHA ${DOCKER_USERNAME}/frontend:latest
        - docker push ${DOCKER_USERNAME}/frontend:$CI_COMMIT_SHORT_SHA
        - docker push ${DOCKER_USERNAME}/frontend:latest

sonarcloud-check:
    stage: sonarcloud-check
    needs:
        - build
    image:
        name: sonarsource/sonar-scanner-cli:latest
        entrypoint: [ "" ]
    variables:
        SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"  # Defines the location of the analysis task cache
        GIT_DEPTH: "0"  # Tells git to fetch all the branches of the project, required by the analysis task
    cache:
        key: "${CI_JOB_NAME}"
        paths:
            - .sonar/cache
    script:
        - sonar-scanner
    only:
        - merge_requests
        - master
        - main
        - develop